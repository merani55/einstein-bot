import telebot
import os

TOKEN = os.getenv("BOT_TOKEN")
bot = telebot.TeleBot(TOKEN)

QUEST = [
    {
        "task": ("–£ —Ç–µ–º—Ä—è–≤—ñ —Å–≤—ñ—Ç–ª–æ —Ö–æ–≤–∞—î—Ç—å—Å—è –∑–∞ —Ç—Ä—å–æ–º–∞ –∫—Ä–æ–∫–∞–º–∏ –Ω–∞–∑–∞–¥.\n"
                 "–†–æ–∑—à–∏—Ñ—Ä—É–π –ø–æ—Å–ª–∞–Ω–Ω—è, —â–æ —Å—Ç–æ—ó—Ç—å –Ω–∞ –ø–æ—Ä–æ–∑—ñ –Ω–æ–≤–∏—Ö –∑–Ω–∞–Ω—å:\n"
                 "'Khoor, Zruog!'\n\n"
                 "–ü–æ—Ä–∞–¥–∞: –ø–æ–¥—É–º–∞–π –ø—Ä–æ —Ç–æ–≥–æ, —Ö—Ç–æ —à—É–∫–∞–≤ —Å–≤—ñ—Ç–ª–æ —É –ª—ñ–Ω–∑–∞—Ö —ñ –ø—Ä–æ–º–µ–Ω—è—Ö."),
        "answer": "hello world",
        "hint": ("¬´–Ü–Ω—Ç–µ–ª–µ–∫—Ç ‚Äî —Ü–µ –Ω–µ –∑–Ω–∞–Ω–Ω—è, –∞ —É—è–≤–∞.¬ª ‚Äì –ê. –ï–π–Ω—à—Ç–µ–π–Ω\n"
                 "¬´–°–≤—ñ—Ç–ª–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Ç–µ, —â–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ —É —Ç–µ–º—Ä—è–≤—ñ.¬ª\n"
                 "–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫: –ó–Ω–∞–π–¥–∏ –º—ñ—Å—Ü–µ, –¥–µ —Ñ—ñ–∑–∏–∫–∞ —Å—Ç–∞–≤–∞–ª–∞ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ–º —Å–≤—ñ—Ç–ª–∞. "
                 "–ö–æ–ª–∏—Å—å —Ç—É—Ç —à–ª—ñ—Ñ—É–≤–∞–ª–∏ –ª—ñ–Ω–∑–∏, —Å—å–æ–≥–æ–¥–Ω—ñ ‚Äî —Ü–µ –±—É–¥—ñ–≤–ª—è –∑—ñ —Å–∫–ª—è–Ω–∏–º –æ–±–ª–∏—á—á—è–º.")
    },
    {
        "task": ("–í—É–ª–∏—Ü—è, –¥–µ —á–∞—Å —ñ –ø—Ä–æ—Å—Ç—ñ—Ä –ø–µ—Ä–µ–ø–ª—ñ—Ç–∞—é—Ç—å—Å—è, —Ç–∞ –Ω–æ–º–µ—Ä, —â–æ —Ç—Ä–∏–º–∞—î –ø–∞–º‚Äô—è—Ç—å –ø—Ä–æ –≥–µ–Ω—ñ—è.\n"
                 "–©–æ–± —Ä—É—Ö–∞—Ç–∏—Å—è –¥–∞–ª—ñ, –∑–Ω–∞–π–¥–∏ –∞–¥—Ä–µ—Å—É, –¥–µ –¥—É–º–∫–∏ –ï–π–Ω—à—Ç–µ–π–Ω–∞ –Ω–∞–±–∏—Ä–∞–ª–∏ —Å–∏–ª—É."),
        "answer": "–º—é–ª–ª–µ—Ä—à—Ç—Ä–∞—Å—Å–µ 54",
        "hint": ("–Ø–∫—â–æ —à—É–∫–∞—î—à –ø–æ—á–∞—Ç–æ–∫ –≤–µ–ª–∏–∫–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó, –ø–æ–¥—É–º–∞–π –ø—Ä–æ –º—ñ—Å—Ü–µ, "
                 "–¥–µ —Å—Ç—ñ–Ω–∏ –∑–Ω–∞—é—Ç—å –≤—Å–µ –ø—Ä–æ —Å–≤—ñ—Ç–ª–æ —ñ —Ç—ñ–Ω—å.")
    },
    {
        "task": ("–Ø–∫—ñ —Ä–æ–∫–∏ –∑–∞–∫–∞—Ä–±—É–≤–∞–ª–∏—Å—è —É –ø–∞–º‚Äô—è—Ç—ñ –æ–¥–Ω–æ–≥–æ –≥–µ–Ω—ñ—è —É —Å—Ç—ñ–Ω–∞—Ö, –¥–µ —Å—Ö–æ–¥–∏–ª–∏—Å—è –ø–µ—Ä—à—ñ –π–æ–≥–æ –¥—É–º–∫–∏?"),
        "answer": "1888-1894",
        "hint": ("–¶–µ –ø–µ—Ä—ñ–æ–¥, –∫–æ–ª–∏ —Ñ–æ—Ä–º—É–≤–∞–ª–æ—Å—è –º–∞–π–±—É—Ç–Ω—î.\n"
                 "–®–∫–æ–ª–∞, –¥–µ –ï–π–Ω—à—Ç–µ–π–Ω –ø—ñ–∑–Ω–∞–≤–∞–≤ –æ—Å–Ω–æ–≤–∏, —Å—Ç–æ—ó—Ç—å —ñ –¥–æ—Å—ñ —É —Ü–µ–Ω—Ç—Ä—ñ –º—ñ—Å—Ç–∞.\n"
                 "–í —ó—ó –Ω–∞–∑–≤—ñ –ø–æ—î–¥–Ω–∞–Ω–æ –∫–æ—Ä–æ–ª—ñ–≤—Å—å–∫—É —Å–ø–∞–¥—â–∏–Ω—É —Ç–∞ –∫–ª–∞—Å–∏—á–Ω—É –æ—Å–≤—ñ—Ç—É.")
    },
    {
        "task": ("–°–º–∞–∫, —â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –Ω–æ–≤—ñ —Å–≤—ñ—Ç–∏ ‚Äî –∑–Ω–∞–π–¥–∏ —Å–ª–æ–≤–æ, —è–∫–µ –æ–ø–∏—Å—É—î –∞—Ä–æ–º–∞—Ç –±—É–ª–æ—á–∫–∏ –∑ –∫–æ—Ä–∏—Ü–µ—é, "
                 "—â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î —à–ª—è—Ö –¥–∞–ª—ñ."),
        "answer": "suuapinga",
        "hint": ("–°–æ–ª–æ–¥–∫—ñ—Å—Ç—å –∂–∏—Ç—Ç—è —Ö–æ–≤–∞—î—Ç—å—Å—è —É –¥—Ä—ñ–±–Ω–∏—Ü—è—Ö.\n"
                 "–Ü–Ω–∫–æ–ª–∏ —à–ª—è—Ö –ª–µ–∂–∏—Ç—å —á–µ—Ä–µ–∑ –∞—Ä–æ–º–∞—Ç —ñ —Å–º–∞–∫, —â–æ –æ–±‚Äô—î–¥–Ω—É—î –ª—é–¥–µ–π.")
    },
    {
        "task": ("–©–æ –≤–∫–∞–∑—É—î –Ω–∞–∑–≤–∞ —Ü—ñ—î—ó –∫–∞–≤‚Äô—è—Ä–Ω—ñ? –ü–æ–¥—É–º–∞–π –ø—Ä–æ –±–æ—Ä–æ—Ç—å–±—É, —â–æ –Ω–µ—Å–µ –∑–º—ñ–Ω–∏ —É —Å–≤—ñ—Ç."),
        "answer": "–±–æ—Ä–æ—Ç—å–±–∞",
        "hint": ("–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó ‚Äî –ª–∏—à–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –ª—é–¥–∏–Ω–∞ —Ç–≤–æ—Ä–∏—Ç—å —Å–ø—Ä–∞–≤–∂–Ω—î.\n"
                 "–î–µ –ª—é–¥–∏–Ω–∞ –∑—É—Å—Ç—Ä—ñ—á–∞—î –º–∞—à–∏–Ω—É, —Ç–∞–º –Ω–∞—Ä–æ–¥–∂—É—î—Ç—å—Å—è –Ω–æ–≤–∞ –µ—Ä–∞.")
    },
    {
        "task": ("–í—Å–µ, —â–æ –≤–∏–≤—á–∞–≤ –ï–π–Ω—à—Ç–µ–π–Ω, –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏–ª–æ—Å—å –Ω–∞ —Ñ–æ—Ä–º—É–ª—É. –ê–ª–µ —ñ—Å—Ç–∏–Ω–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ ‚Äî —É —Ä—É—Å—ñ –∂–∏—Ç—Ç—è.\n"
                 "–ù–∞ —Ä–∏–Ω–∫—É, –¥–µ –≤—Å–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è, —à—É–∫–∞–π –ø—Ä–æ–¥—É–∫—Ç, —â–æ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –≤—ñ—á–Ω—ñ—Å—Ç—å —ñ –Ω–µ —Å—Ç–∞—Ä—ñ—î."),
        "answer": "–º–µ–¥",
        "hint": ("–ñ–∏—Ç—Ç—è —Ä—É—Ö–∞—î—Ç—å—Å—è, —è–∫ –º–µ–¥ ‚Äî —â–æ –Ω–µ –ø—Å—É—î—Ç—å—Å—è —ñ –Ω–µ —Å—Ç–∞—Ä—ñ—î.\n"
                 "–¶–µ–π —Å–∏–º–≤–æ–ª –ø–æ—Å—Ç—ñ–π–Ω–æ—Å—Ç—ñ —Å–µ—Ä–µ–¥ –∑–º—ñ–Ω –¥–æ–ø–æ–º–æ–∂–µ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ —Å—É—Ç—å.")
    },
]

user_state = {}  # chat_id: {step: int, hint_requested: bool}

@bot.message_handler(commands=['start'])
def start(message):
    user_state[message.chat.id] = {"step": 0, "hint_requested": False}
    bot.send_message(message.chat.id,
                     "–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –≤ –∫–≤–µ—Å—Ç ‚Äò–ö–æ–¥ –ï–π–Ω—à—Ç–µ–π–Ω–∞‚Äô! –ù–∞–ø–∏—à–∏ '–ü–æ—á–∞—Ç–∏', —â–æ–± –ø–æ—á–∞—Ç–∏.")

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    chat_id = message.chat.id
    text = message.text.strip().lower()

    if chat_id not in user_state:
        user_state[chat_id] = {"step": 0, "hint_requested": False}

    step = user_state[chat_id]["step"]
    hint_requested = user_state[chat_id]["hint_requested"]

    # –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∫—Ä–æ–∫: —á–µ–∫–∞—Ç–∏ '–ø–æ—á–∞—Ç–∏'
    if step == 0:
        if text == "–ø–æ—á–∞—Ç–∏":
            bot.send_message(chat_id, QUEST[0]["task"])
            user_state[chat_id]["step"] = 1
            user_state[chat_id]["hint_requested"] = False
        else:
            bot.send_message(chat_id, "–ù–∞–ø–∏—à–∏ '–ü–æ—á–∞—Ç–∏', —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –∫–≤–µ—Å—Ç.")
        return

    # –ö—ñ–Ω–µ—Ü—å –∫–≤–µ—Å—Ç—É
    if step > len(QUEST):
        bot.send_message(chat_id, "–ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –î—è–∫—É—î–º–æ –∑–∞ —É—á–∞—Å—Ç—å.")
        return

    # –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–ø—Ä–æ—Å–∏–≤ –ø—ñ–¥–∫–∞–∑–∫—É
    if text == "–ø—ñ–¥–∫–∞–∑–∫–∞":
        if step <= len(QUEST) and step > 0:
            bot.send_message(chat_id, QUEST[step - 1]["hint"])
            user_state[chat_id]["hint_requested"] = True
        else:
            bot.send_message(chat_id, "–ü–æ–∫–∏ –Ω–µ–º–∞—î –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è —Ü—å–æ–≥–æ –µ—Ç–∞–ø—É.")
        return

    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    if step <= len(QUEST) and step > 0:
        expected_answer = QUEST[step - 1]["answer"].lower()

        # –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: –ø—Ä–∏–±—Ä–∞—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏, –∑–Ω–∞–∫–∏ –ø—É–Ω–∫—Ç—É–∞—Ü—ñ—ó, –ø—Ä–∏–≤–µ—Å—Ç–∏ –¥–æ –Ω–∏–∂–Ω—å–æ–≥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É
        def normalize(text):
            import re
            return re.sub(r"[^a-z–∞-—è0-9]+", "", text.lower())

        if normalize(text) == normalize(expected_answer):
            bot.send_message(chat_id, "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ")
            user_state[chat_id]["step"] += 1
            user_state[chat_id]["hint_requested"] = False
            if user_state[chat_id]["step"] <= len(QUEST):
                bot.send_message(chat_id, QUEST[user_state[chat_id]["step"] - 1]["task"])
            else:
                bot.send_message(chat_id, "–í—ñ—Ç–∞—î–º–æ! –í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∫–≤–µ—Å—Ç ‚Äò–ö–æ–¥ –ï–π–Ω—à—Ç–µ–π–Ω–∞‚Äô. –î—è–∫—É—î–º–æ –∑–∞ —É—á–∞—Å—Ç—å!")
        else:
            if not hint_requested:
                bot.send_message(chat_id, "–°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ –∞–±–æ –Ω–∞–ø–∏—à–∏ '–ü—ñ–¥–∫–∞–∑–∫–∞', —è–∫—â–æ —Ö–æ—á–µ—à –¥–æ–ø–æ–º–æ–≥—É.")
            else:
                bot.send_message(chat_id, "–í—Å–µ —â–µ –Ω–µ –≤–∏–π—à–ª–æ. –ü–æ–¥—É–º–∞–π —É–≤–∞–∂–Ω—ñ—à–µ –∞–±–æ –∑–≤–µ—Ä–Ω–∏—Å—å –¥–æ –ø—ñ–¥–∫–∞–∑–∫–∏.")

if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ")
    bot.polling(none_stop=True)

